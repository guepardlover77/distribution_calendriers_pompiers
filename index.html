<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive - Distribution Calendriers Pompiers</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- √âcran de connexion -->
    <div id="login-screen" class="login-screen">
        <div class="login-container">
            <div class="login-header">
                <h1>Connexion</h1>
                <p class="login-subtitle">Distribution Calendriers Pompiers</p>
            </div>
            <form id="login-form" class="login-form">
                <div class="form-group">
                    <label for="login-username">Nom d'utilisateur</label>
                    <input
                        type="text"
                        id="login-username"
                        name="username"
                        required
                        autocomplete="username"
                        placeholder="Entrez votre nom d'utilisateur"
                    >
                </div>
                <div class="form-group">
                    <label for="login-password">Mot de passe</label>
                    <input
                        type="password"
                        id="login-password"
                        name="password"
                        required
                        autocomplete="current-password"
                        placeholder="Entrez votre mot de passe"
                    >
                </div>
                <div id="login-error" class="login-error" style="display: none;"></div>
                <button type="submit" class="btn btn-primary btn-login">
                    Se connecter
                </button>
                <p class="login-warning">Identifiant : admin / MDP : admin123</p>
                <p class="login-warning">‚ö†Ô∏è Usage interne uniquement</p>
            </form>
        </div>
    </div>

    <!-- Application principale -->
    <div id="main-app" class="container" style="display: none;">
        <header>
            <h1>Carte Interactive de Distribution</h1>

            <div class="header-controls">
                <!-- Statut de connexion -->
                <div class="connection-status" id="connection-status">
                    <span class="status-indicator" id="status-indicator"></span>
                    <span class="status-text" id="status-text">En ligne</span>
                    <span class="pending-count" id="pending-count" style="display: none;">0 en attente</span>
                </div>

                <!-- Info utilisateur -->
                <div class="user-info">
                    <span class="user-name" id="user-name-display">Chargement...</span>
                    <button id="logout-btn" class="btn btn-secondary btn-logout">
                        D√©connexion
                    </button>
                </div>
            </div>
        </header>


        <!-- Contenu carte -->
        <div id="map-tab" class="tab-content active">
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>

        <!-- Contenu statistiques -->
        <div id="stats-tab" class="tab-content">
            <div class="stats-dashboard">
                <h2 class="stats-title">üìä Tableau de bord des statistiques</h2>

                <!-- Cartes de statistiques globales -->
                <div class="stats-cards-grid">
                    <div class="stat-card-large">
                        <div class="stat-icon-large">üìã</div>
                        <div class="stat-value-large" id="total-distributions">0</div>
                        <div class="stat-label-large">Distributions totales</div>
                    </div>
                    <div class="stat-card-large success">
                        <div class="stat-icon-large">‚úÖ</div>
                        <div class="stat-value-large" id="stats-effectue">0</div>
                        <div class="stat-label-large">Effectu√©s</div>
                    </div>
                    <div class="stat-card-large warning">
                        <div class="stat-icon-large">üîÑ</div>
                        <div class="stat-value-large" id="stats-repasser">0</div>
                        <div class="stat-label-large">√Ä repasser</div>
                    </div>
                    <div class="stat-card-large danger">
                        <div class="stat-icon-large">‚ùå</div>
                        <div class="stat-value-large" id="stats-refus">0</div>
                        <div class="stat-label-large">Refus</div>
                    </div>
                </div>

                <!-- Graphiques -->
                <div class="charts-grid">
                    <!-- R√©partition par status -->
                    <div class="chart-container">
                        <h3 class="chart-title">R√©partition par status</h3>
                        <canvas id="statusChart"></canvas>
                    </div>

                    <!-- Montants collect√©s -->
                    <div class="chart-container">
                        <h3 class="chart-title">Montants collect√©s</h3>
                        <canvas id="amountChart"></canvas>
                    </div>

                    <!-- Moyens de paiement -->
                    <div class="chart-container">
                        <h3 class="chart-title">Moyens de paiement</h3>
                        <canvas id="paymentChart"></canvas>
                    </div>

                    <!-- √âvolution dans le temps -->
                    <div class="chart-container chart-wide">
                        <h3 class="chart-title">√âvolution des distributions</h3>
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>

                <!-- Statistiques d√©taill√©es -->
                <div class="detailed-stats">
                    <h3>Statistiques d√©taill√©es</h3>
                    <div class="stats-table">
                        <div class="stats-row">
                            <span class="stats-label">üí∞ Montant moyen par distribution</span>
                            <span class="stats-value" id="avg-amount">0.00 ‚Ç¨</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">üìà Taux de r√©ussite</span>
                            <span class="stats-value" id="success-rate">0%</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">üîÑ Taux √† repasser</span>
                            <span class="stats-value" id="repasser-rate">0%</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">‚ùå Taux de refus</span>
                            <span class="stats-value" id="refus-rate">0%</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">üíµ Part en esp√®ces</span>
                            <span class="stats-value" id="cash-percent">0%</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">üí≥ Part en ch√®ques</span>
                            <span class="stats-value" id="check-percent">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Liste (nouveau) -->
        <div id="list-tab" class="tab-content">
            <div class="list-container">
                <div class="list-header">
                    <h2>Liste des Distributions</h2>
                </div>

                <!-- Recherche rapide -->
                <div class="list-search">
                    <input type="text" id="quick-search-input"
                           placeholder="üîç Rechercher une adresse..." autocomplete="off">
                </div>

                <!-- Filtres par date -->
                <div class="list-date-filters">
                    <div class="date-filter-group">
                        <label for="date-from">Du :</label>
                        <input type="date" id="date-from" class="date-input">
                    </div>
                    <div class="date-filter-group">
                        <label for="date-to">Au :</label>
                        <input type="date" id="date-to" class="date-input">
                    </div>
                    <button class="btn-reset-dates" id="reset-dates-btn" title="R√©initialiser les dates">‚Üª</button>
                </div>

                <!-- Filtres par statut -->
                <div class="list-filters">
                    <button class="filter-btn active" data-filter="all">Toutes</button>
                    <button class="filter-btn" data-filter="effectue">Effectu√©</button>
                    <button class="filter-btn" data-filter="repasser">√Ä repasser</button>
                    <button class="filter-btn" data-filter="refus">Refus</button>
                </div>

                <!-- Panel filtres avanc√©s -->
                <div class="advanced-filters-panel">
                    <div class="filters-header">
                        <h3>Filtres avanc√©s</h3>
                        <span id="active-filters-badge" class="filter-badge">0</span>
                        <button class="btn-clear-filters" id="clear-all-filters">R√©initialiser tout</button>
                    </div>

                    <div class="filters-grid">
                        <!-- Filtre paiement -->
                        <div class="filter-group">
                            <label for="filter-payment">Moyen de paiement</label>
                            <select id="filter-payment" class="filter-select">
                                <option value="all">Tous</option>
                                <option value="espece">üíµ Esp√®ces</option>
                                <option value="cheque">üí≥ Ch√®que</option>
                                <option value="unspecified">Non sp√©cifi√©</option>
                            </select>
                        </div>

                        <!-- Filtre bin√¥me -->
                        <div class="filter-group">
                            <label for="filter-binome">Bin√¥me</label>
                            <select id="filter-binome" class="filter-select">
                                <option value="all">Tous</option>
                                <!-- Rempli dynamiquement depuis NocoDB -->
                            </select>
                        </div>

                        <!-- Filtre zone -->
                        <div class="filter-group">
                            <label for="filter-zone">Zone g√©ographique</label>
                            <select id="filter-zone" class="filter-select">
                                <option value="">Toutes les zones</option>
                                <!-- Rempli dynamiquement depuis zones array -->
                            </select>
                        </div>
                    </div>

                    <!-- Affichage des filtres actifs -->
                    <div id="active-filters-display" class="active-filters-display"></div>
                </div>

                <div class="list-content" id="distributions-list">
                    <p class="empty-state">Aucune distribution enregistr√©e</p>
                </div>
            </div>
        </div>

        <!-- Onglet Administration (admin seulement) -->
        <div id="admin-tab" class="tab-content">
            <div class="admin-container">
                <div class="admin-header">
                    <h2>‚öôÔ∏è Administration</h2>
                    <p class="admin-subtitle">G√©rez les bin√¥mes et les zones</p>
                </div>

                <!-- Section Gestion des Bin√¥mes -->
                <div class="admin-section">
                    <div class="section-header">
                        <h3>üë• Gestion des Bin√¥mes</h3>
                        <button class="btn-primary" id="add-binome-btn">
                            <i data-lucide="user-plus"></i>
                            Ajouter un bin√¥me
                        </button>
                    </div>

                    <div class="binomes-list" id="admin-binomes-list">
                        <p class="empty-state">Chargement des bin√¥mes...</p>
                    </div>
                </div>

                <!-- Section Gestion des Zones -->
                <div class="admin-section">
                    <div class="section-header">
                        <h3>üó∫Ô∏è Gestion des Zones</h3>
                        <p class="section-hint">Modifiez les bin√¥mes assign√©s ou les couleurs des zones</p>
                    </div>

                    <div class="zones-list" id="admin-zones-list">
                        <p class="empty-state">Aucune zone cr√©√©e</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <nav class="bottom-nav" id="bottom-nav">
            <button class="bottom-nav-btn" id="add-distribution-btn-bottom" aria-label="Ajouter distribution">
                <i data-lucide="plus-circle"></i>
                <span>Ajouter</span>
            </button>
            <button class="bottom-nav-btn active" data-tab="map" aria-label="Carte">
                <i data-lucide="map"></i>
                <span>Carte</span>
            </button>
            <button class="bottom-nav-btn" data-tab="list" aria-label="Liste">
                <i data-lucide="list"></i>
                <span>Liste</span>
            </button>
            <button class="bottom-nav-btn" data-tab="stats" aria-label="Statistiques">
                <i data-lucide="bar-chart-3"></i>
                <span>Stats</span>
            </button>
            <button class="bottom-nav-btn" id="admin-tab-btn" data-tab="admin" aria-label="Administration" style="display: none;">
                <i data-lucide="settings"></i>
                <span>Admin</span>
            </button>
        </nav>
    </div>

    <!-- Modal formulaire distribution -->
    <div id="distribution-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Ajouter une distribution</h2>
                <button class="modal-close" id="close-modal-btn">&times;</button>
            </div>
            <form id="distribution-form">
                <input type="hidden" id="distribution-id">

                <!-- Toggle mode saisie -->
                <div class="form-mode-toggle">
                    <button type="button" class="mode-btn active" data-mode="auto">
                        üîç Recherche d'adresse
                    </button>
                    <button type="button" class="mode-btn" data-mode="manual">
                        ‚úèÔ∏è Saisie manuelle
                    </button>
                </div>

                <!-- Mode automatique -->
                <div id="auto-mode" class="address-mode">
                    <!-- Recherche de ville -->
                    <div class="form-group">
                        <label for="city-input" class="search-label">1. S√©lectionnez votre ville/village</label>
                        <div class="input-with-badge">
                            <input
                                type="text"
                                id="city-input"
                                placeholder="Rechercher une ville ou un village..."
                                autocomplete="off"
                            >
                            <button type="button" id="detect-city-btn" class="detect-btn" title="D√©tecter ma ville actuelle">
                                üìç
                            </button>
                        </div>
                        <div id="city-results" class="search-results"></div>
                        <div id="selected-city" class="selected-city"></div>
                    </div>

                    <!-- Recherche d'adresse -->
                    <div class="form-group">
                        <label for="address-input" class="search-label">2. Recherchez une adresse *</label>
                        <input
                            type="text"
                            id="address-input"
                            placeholder="Entrez d'abord une ville..."
                            autocomplete="off"
                            required
                            disabled
                        >
                        <div id="address-results" class="search-results"></div>
                        <!-- Champs cach√©s pour les coordonn√©es -->
                        <input type="hidden" id="dist-lat">
                        <input type="hidden" id="dist-lng">
                    </div>
                </div>

                <!-- Mode manuel -->
                <div id="manual-mode" class="address-mode" style="display: none;">
                    <div class="form-group">
                        <label for="dist-address-manual">Adresse postale *</label>
                        <input type="text" id="dist-address-manual" placeholder="Entrez l'adresse manuellement">
                        <small class="form-hint">Exemple: 12 Rue Principale, 69001 Lyon</small>
                    </div>

                    <div class="manual-location-info">
                        <p class="info-text">
                            üìç <strong>D√©finir la position sur la carte</strong><br>
                            <span id="click-map-instruction">Cliquez sur la carte pour placer le marqueur</span>
                        </p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dist-lat-manual">Latitude *</label>
                            <input type="number" id="dist-lat-manual" step="0.000001" placeholder="45.764043" required>
                        </div>
                        <div class="form-group">
                            <label for="dist-lng-manual">Longitude *</label>
                            <input type="number" id="dist-lng-manual" step="0.000001" placeholder="4.835659" required>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dist-status">Status *</label>
                        <select id="dist-status" required>
                            <option value="effectue">‚úÖ Effectu√©</option>
                            <option value="repasser">üîÑ √Ä repasser</option>
                            <option value="refus">‚ùå Refus</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="dist-amount">Montant (‚Ç¨)</label>
                        <input type="number" id="dist-amount" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label for="dist-payment">Moyen de r√®glement</label>
                    <select id="dist-payment">
                        <option value="">Non sp√©cifi√©</option>
                        <option value="espece">üíµ Esp√®ces</option>
                        <option value="cheque">üí≥ Ch√®que</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dist-notes">Notes / Commentaires</label>
                    <textarea id="dist-notes" rows="3" placeholder="Informations compl√©mentaires..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-modal-btn">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal zone properties -->
    <div id="zone-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="zone-modal-title">Propri√©t√©s de la zone</h2>
                <button class="modal-close" id="close-zone-modal">&times;</button>
            </div>
            <form id="zone-form">
                <div class="form-group">
                    <label for="zone-name">Nom de la zone *</label>
                    <input type="text" id="zone-name" required placeholder="Ex: Secteur Centre-Ville">
                </div>

                <div class="form-group">
                    <label for="zone-color">Couleur</label>
                    <div class="color-picker-container">
                        <input type="color" id="zone-color" value="#10b981">
                        <div class="color-presets">
                            <button type="button" class="color-preset" data-color="#10b981" style="background: #10b981;" title="Vert"></button>
                            <button type="button" class="color-preset" data-color="#3b82f6" style="background: #3b82f6;" title="Bleu"></button>
                            <button type="button" class="color-preset" data-color="#f59e0b" style="background: #f59e0b;" title="Orange"></button>
                            <button type="button" class="color-preset" data-color="#ef4444" style="background: #ef4444;" title="Rouge"></button>
                            <button type="button" class="color-preset" data-color="#8b5cf6" style="background: #8b5cf6;" title="Violet"></button>
                            <button type="button" class="color-preset" data-color="#ec4899" style="background: #ec4899;" title="Rose"></button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="zone-binome">Bin√¥me assign√©</label>
                    <div class="autocomplete-container">
                        <input
                            type="text"
                            id="zone-binome"
                            placeholder="Rechercher un bin√¥me..."
                            autocomplete="off"
                        >
                        <div id="zone-binome-suggestions" class="autocomplete-suggestions"></div>
                    </div>
                    <small class="form-hint">Laissez vide pour ne pas assigner de bin√¥me</small>
                </div>

                <div class="zone-stats-preview" id="zone-stats-preview">
                    <h3>Statistiques de la zone</h3>
                    <div class="stats-grid-mini">
                        <div class="stat-mini">
                            <span class="stat-mini-value" id="zone-stat-total">0</span>
                            <span class="stat-mini-label">Distributions</span>
                        </div>
                        <div class="stat-mini success">
                            <span class="stat-mini-value" id="zone-stat-effectue">0</span>
                            <span class="stat-mini-label">Effectu√©s</span>
                        </div>
                        <div class="stat-mini warning">
                            <span class="stat-mini-value" id="zone-stat-repasser">0</span>
                            <span class="stat-mini-label">√Ä repasser</span>
                        </div>
                        <div class="stat-mini danger">
                            <span class="stat-mini-value" id="zone-stat-refus">0</span>
                            <span class="stat-mini-label">Refus</span>
                        </div>
                    </div>
                    <div class="stat-mini-amount">
                        <strong>Montant total:</strong>
                        <span id="zone-stat-amount">0.00 ‚Ç¨</span>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-zone-modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Bin√¥me (Create/Edit) -->
    <div id="binome-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="binome-modal-title">Ajouter un bin√¥me</h2>
                <button class="modal-close" id="close-binome-modal">&times;</button>
            </div>
            <form id="binome-form">
                <div class="form-group">
                    <label for="binome-username">Nom d'utilisateur *</label>
                    <input type="text" id="binome-username" required placeholder="Ex: jdupont">
                    <small class="form-hint">Utilis√© pour la connexion</small>
                </div>

                <div class="form-group">
                    <label for="binome-name">Nom complet *</label>
                    <input type="text" id="binome-name" required placeholder="Ex: Jean Dupont">
                </div>

                <div class="form-group">
                    <label for="binome-password">Mot de passe *</label>
                    <input type="password" id="binome-password" placeholder="Laisser vide pour conserver">
                    <small class="form-hint">Minimum 6 caract√®res. Laisser vide pour ne pas changer (mode √©dition)</small>
                </div>

                <div class="form-group">
                    <label for="binome-is-admin">
                        <input type="checkbox" id="binome-is-admin">
                        Administrateur
                    </label>
                    <small class="form-hint">Les administrateurs ont acc√®s √† toutes les fonctionnalit√©s</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-binome-modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Configuration pour GitHub Pages -->
    <script src="config.js"></script>
    <script src="api-proxy.js"></script>
    <script src="config-adapter.js"></script>

    <!-- Custom JS -->
    <script src="app.js"></script>
</body>
</html>
