name: Build APK & Release

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'PLAN_ACTION_MARKETING.md'
      - 'PITCH_DECK.md'
      - 'TARIFICATION_B2B.md'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

jobs:
  build-and-release:
    name: Build APK and Create Release
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit info
        id: commit_info
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          # Get commit message and filter out Claude-related lines
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=format:"%B" | grep -v -E "(Claude|Co-Authored-By|Generated with)" >> $GITHUB_OUTPUT || true
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "commit_date=$(git log -1 --pretty=format:'%ci')" >> $GITHUB_OUTPUT

      - name: Calculate next version
        id: version
        run: |
          # Recuperer le dernier tag de version (format vX.Y.Z ou vX.Y.Z-xxx)
          LATEST_TAG=$(git tag -l 'v*' --sort=-version:refname | head -n 1)
          echo "Latest tag found: $LATEST_TAG"

          if [ -z "$LATEST_TAG" ]; then
            # Pas de tag existant, commencer a v1.0.0
            MAJOR=1
            MINOR=0
            PATCH=0
          else
            # Extraire les numeros de version (ignorer le suffixe -xxx si present)
            VERSION_PART=$(echo "$LATEST_TAG" | sed 's/^v//' | sed 's/-.*//')
            MAJOR=$(echo "$VERSION_PART" | cut -d. -f1)
            MINOR=$(echo "$VERSION_PART" | cut -d. -f2)
            PATCH=$(echo "$VERSION_PART" | cut -d. -f3)

            # Incrementer le patch
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: react-ionic-app/package-lock.json

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          # Cache disabled - android/ folder is gitignored and generated during CI

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        working-directory: react-ionic-app
        run: npm ci

      - name: Build web app
        working-directory: react-ionic-app
        run: npm run build
        env:
          VITE_NOCODB_BASE_URL: ${{ secrets.VITE_NOCODB_BASE_URL }}
          VITE_NOCODB_API_TOKEN: ${{ secrets.VITE_NOCODB_API_TOKEN }}

      - name: Add Android platform
        working-directory: react-ionic-app
        run: npx cap add android

      - name: Sync Capacitor
        working-directory: react-ionic-app
        run: npx cap sync android

      - name: Fix Play Services Location compatibility
        working-directory: react-ionic-app/android
        run: |
          # Ajouter la resolution de dependance pour play-services-location
          # Cela corrige le warning D8 avec la version 21.1.0
          cat >> app/build.gradle << 'EOF'

          // Force une version compatible de Google Play Services Location
          configurations.all {
              resolutionStrategy {
                  force 'com.google.android.gms:play-services-location:21.3.0'
              }
          }
          EOF

          echo "Play Services Location fix applied"

      - name: Verify and fix Android permissions
        working-directory: react-ionic-app/android/app/src/main
        run: |
          echo "=== Current AndroidManifest.xml ==="
          cat AndroidManifest.xml

          # Vérifier que les permissions de localisation sont présentes
          if ! grep -q "ACCESS_FINE_LOCATION" AndroidManifest.xml; then
            echo "Adding missing location permissions..."
            sed -i 's|</manifest>|    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />\n    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />\n</manifest>|' AndroidManifest.xml
          fi

          echo "=== Updated AndroidManifest.xml ==="
          cat AndroidManifest.xml

      - name: Update version in build.gradle
        working-directory: react-ionic-app/android/app
        run: |
          VERSION_CODE=$(date +%Y%m%d%H)
          VERSION_NAME="${{ steps.version.outputs.version }}"
          sed -i "s/versionCode 1/versionCode $VERSION_CODE/" build.gradle
          sed -i "s/versionName \"1.0\"/versionName \"$VERSION_NAME\"/" build.gradle
          echo "Updated to versionCode: $VERSION_CODE, versionName: $VERSION_NAME"

      - name: Setup keystore for signing
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        working-directory: react-ionic-app/android
        run: |
          # Decode keystore from base64
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > calendriers-pompiers.keystore

          # Create keystore.properties file
          cat > keystore.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=../calendriers-pompiers.keystore
          EOF

          echo "Keystore setup completed"

      - name: Configure signing in build.gradle
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        working-directory: react-ionic-app/android/app
        run: |
          # Add signing configuration to build.gradle
          # Insert after "apply plugin: 'com.android.application'"
          sed -i "/apply plugin: 'com.android.application'/a\\
          \\n\
          // Load keystore properties\\n\
          def keystorePropertiesFile = rootProject.file(\"keystore.properties\")\\n\
          def keystoreProperties = new Properties()\\n\
          if (keystorePropertiesFile.exists()) {\\n\
              keystoreProperties.load(new FileInputStream(keystorePropertiesFile))\\n\
          }" build.gradle

          # Add signingConfigs block before buildTypes
          sed -i "/defaultConfig {/,/}/a\\
          \\n\
          signingConfigs {\\n\
              release {\\n\
                  if (keystorePropertiesFile.exists()) {\\n\
                      keyAlias keystoreProperties['keyAlias']\\n\
                      keyPassword keystoreProperties['keyPassword']\\n\
                      storeFile file(keystoreProperties['storeFile'])\\n\
                      storePassword keystoreProperties['storePassword']\\n\
                  }\\n\
              }\\n\
          }" build.gradle

          # Add signingConfig reference in release buildType
          sed -i "/buildTypes {/,/release {/s/release {/release {\\n            signingConfig signingConfigs.release/" build.gradle

          echo "Signing configuration added to build.gradle"

      - name: Make gradlew executable
        working-directory: react-ionic-app/android
        run: chmod +x gradlew

      - name: Build APK (Debug)
        working-directory: react-ionic-app/android
        run: ./gradlew assembleDebug --no-daemon

      - name: Build APK (Release)
        working-directory: react-ionic-app/android
        run: ./gradlew assembleRelease --no-daemon

      - name: Rename APK files
        run: |
          mkdir -p artifacts
          VERSION="${{ steps.version.outputs.version }}"

          # Copy debug APK
          if [ -f "react-ionic-app/android/app/build/outputs/apk/debug/app-debug.apk" ]; then
            cp react-ionic-app/android/app/build/outputs/apk/debug/app-debug.apk \
               artifacts/calendriers-pompiers-v${VERSION}-debug.apk
            echo "Debug APK copied"
          fi

          # Copy release APK (signed or unsigned)
          if [ -f "react-ionic-app/android/app/build/outputs/apk/release/app-release.apk" ]; then
            cp react-ionic-app/android/app/build/outputs/apk/release/app-release.apk \
               artifacts/calendriers-pompiers-v${VERSION}-release.apk
            echo "Release APK (signed) copied"
          elif [ -f "react-ionic-app/android/app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            cp react-ionic-app/android/app/build/outputs/apk/release/app-release-unsigned.apk \
               artifacts/calendriers-pompiers-v${VERSION}-release-unsigned.apk
            echo "Release APK (unsigned) copied"
          fi

          ls -la artifacts/

      - name: Generate release tag
        id: tag
        run: |
          TAG_NAME="v${{ steps.version.outputs.version }}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Generated tag: $TAG_NAME"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: "Calendriers Pompiers ${{ steps.tag.outputs.tag_name }}"
          body: |
            ## Calendriers Pompiers - Version ${{ steps.version.outputs.version }}

            **Version:** `${{ steps.version.outputs.version }}`
            **Commit:** `${{ steps.commit_info.outputs.sha_short }}`
            **Date:** ${{ steps.commit_info.outputs.commit_date }}

            ### Changements

            ${{ steps.commit_info.outputs.commit_message }}

            ---

            ### Fichiers disponibles

            - `calendriers-pompiers-v${{ steps.version.outputs.version }}-debug.apk` : Version debug (pour tests uniquement)
            - `calendriers-pompiers-v${{ steps.version.outputs.version }}-release.apk` : **Version release signée (RECOMMANDÉE pour production)**

            ### Installation

            1. Téléchargez le fichier APK release (version signée)
            2. Sur votre téléphone Android, activez "Sources inconnues" dans les paramètres de sécurité
            3. Ouvrez le fichier APK téléchargé pour l'installer
            4. Acceptez les permissions demandées (géolocalisation, etc.)

            ---
            *Build automatique genere par GitHub Actions*
          files: |
            artifacts/*.apk
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apk-v${{ steps.version.outputs.version }}
          path: artifacts/*.apk
          retention-days: 30
