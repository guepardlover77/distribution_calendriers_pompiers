name: Build APK & Release

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'PLAN_ACTION_MARKETING.md'
      - 'PITCH_DECK.md'
      - 'TARIFICATION_B2B.md'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

jobs:
  build-and-release:
    name: Build APK and Create Release
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit info
        id: commit_info
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=format:"%B" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
          echo "commit_date=$(git log -1 --pretty=format:'%ci')" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: react-ionic-app/package-lock.json

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          # Cache disabled - android/ folder is gitignored and generated during CI

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        working-directory: react-ionic-app
        run: npm ci

      - name: Build web app
        working-directory: react-ionic-app
        run: npm run build
        env:
          VITE_NOCODB_BASE_URL: ${{ secrets.VITE_NOCODB_BASE_URL }}
          VITE_NOCODB_API_TOKEN: ${{ secrets.VITE_NOCODB_API_TOKEN }}

      - name: Add Android platform
        working-directory: react-ionic-app
        run: npx cap add android

      - name: Sync Capacitor
        working-directory: react-ionic-app
        run: npx cap sync android

      - name: Update version in build.gradle
        working-directory: react-ionic-app/android/app
        run: |
          VERSION_CODE=$(date +%Y%m%d%H)
          VERSION_NAME="1.0.0-${{ steps.commit_info.outputs.sha_short }}"
          sed -i "s/versionCode 1/versionCode $VERSION_CODE/" build.gradle
          sed -i "s/versionName \"1.0\"/versionName \"$VERSION_NAME\"/" build.gradle
          echo "Updated to versionCode: $VERSION_CODE, versionName: $VERSION_NAME"

      - name: Make gradlew executable
        working-directory: react-ionic-app/android
        run: chmod +x gradlew

      - name: Build APK (Debug)
        working-directory: react-ionic-app/android
        run: ./gradlew assembleDebug --no-daemon

      - name: Build APK (Release unsigned)
        working-directory: react-ionic-app/android
        run: ./gradlew assembleRelease --no-daemon
        continue-on-error: true

      - name: Rename APK files
        run: |
          mkdir -p artifacts

          # Copy debug APK
          if [ -f "react-ionic-app/android/app/build/outputs/apk/debug/app-debug.apk" ]; then
            cp react-ionic-app/android/app/build/outputs/apk/debug/app-debug.apk \
               artifacts/calendriers-pompiers-${{ steps.commit_info.outputs.sha_short }}-debug.apk
            echo "Debug APK copied"
          fi

          # Copy release APK if exists
          if [ -f "react-ionic-app/android/app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            cp react-ionic-app/android/app/build/outputs/apk/release/app-release-unsigned.apk \
               artifacts/calendriers-pompiers-${{ steps.commit_info.outputs.sha_short }}-release-unsigned.apk
            echo "Release APK copied"
          fi

          ls -la artifacts/

      - name: Generate release tag
        id: tag
        run: |
          TAG_NAME="v1.0.0-${{ steps.commit_info.outputs.sha_short }}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Generated tag: $TAG_NAME"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: "Release ${{ steps.tag.outputs.tag_name }}"
          body: |
            ## Calendriers Pompiers - Build Automatique

            **Commit:** `${{ steps.commit_info.outputs.sha_short }}`
            **Auteur:** ${{ steps.commit_info.outputs.commit_author }}
            **Date:** ${{ steps.commit_info.outputs.commit_date }}

            ### Description du commit

            ${{ steps.commit_info.outputs.commit_message }}

            ---

            ### Fichiers disponibles

            - `calendriers-pompiers-*-debug.apk` : Version debug (pour tests)
            - `calendriers-pompiers-*-release-unsigned.apk` : Version release non signée

            ### Installation

            1. Téléchargez le fichier APK debug
            2. Sur votre téléphone Android, activez "Sources inconnues" dans les paramètres
            3. Installez l'APK

            ---
            *Build automatique généré par GitHub Actions*
          files: |
            artifacts/*.apk
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ steps.commit_info.outputs.sha_short }}
          path: artifacts/*.apk
          retention-days: 30
